<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoH AutoProxy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            400: 'rgba(255, 255, 255, 0.4)',
                            500: 'rgba(255, 255, 255, 0.5)',
                            600: 'rgba(255, 255, 255, 0.6)',
                            700: 'rgba(255, 255, 255, 0.7)',
                            800: 'rgba(255, 255, 255, 0.8)',
                            900: 'rgba(255, 255, 255, 0.9)',
                        },
                        darkglass: {
                            100: 'rgba(15, 23, 42, 0.3)',
                            200: 'rgba(15, 23, 42, 0.5)',
                            300: 'rgba(15, 23, 42, 0.7)',
                            400: 'rgba(15, 23, 42, 0.8)',
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #ffffff;
            min-height: 100vh;
        }
        .dark body {
            background-color: #020617;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-card {
            background: #0f172a;
            border: 1px solid #1e293b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e2e8f0;
        }
        .dark .glass-header {
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid #1e293b;
        }

        .glass-sidebar {
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }
        .dark .glass-sidebar {
            background: #0f172a;
            border-right: 1px solid #1e293b;
        }

        .btn-glass {
            position: relative;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .btn-glass::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }
        .btn-glass:hover::before {
            left: 100%;
        }
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .btn-glass:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-glass-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.9));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .btn-glass-primary {
             background: linear-gradient(135deg, rgba(14, 165, 233, 0.7), rgba(56, 189, 248, 0.8));
        }
        .btn-glass-primary:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 1.0));
        }

        .btn-glass-secondary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(79, 70, 229, 0.9));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .btn-glass-secondary {
             background: linear-gradient(135deg, rgba(129, 140, 248, 0.7), rgba(99, 102, 241, 0.8));
        }
        .btn-glass-secondary:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(79, 70, 229, 1.0));
        }

        .list-move,
        .list-enter-active,
        .list-leave-active {
            transition: all 0.3s ease;
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateX(30px);
        }
        .list-leave-active {
            position: absolute;
        }
        .dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 100;
        }

        .sidebar-link { position: relative; display: flex; align-items: center; padding: 0.75rem 1.5rem; color: #64748b; transition: all 0.2s; font-weight: 500; }
        .dark .sidebar-link { color: #94a3b8; }
        .sidebar-link:hover { color: #2563eb; background-color: #e2e8f0; }
        .dark .sidebar-link:hover { color: #38bdf8; background-color: #1e293b; }
        .sidebar-link.active { color: #2563eb; background-color: #dbeafe; border-right: 3px solid #2563eb; }
        .dark .sidebar-link.active { color: #38bdf8; background-color: rgba(56, 189, 248, 0.15); border-right: 3px solid #38bdf8; }
        .sidebar-link i { width: 1.5rem; text-align: center; margin-right: 0.75rem; }
        
        .toggle-checkbox { appearance: none; background: #fff; border-width: 0; width: 1.25rem; height: 1.25rem; border-radius: 50%; position: absolute; top: 0.125rem; left: 0.125rem; transition: transform 0.3s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .toggle-track { width: 2.75rem; height: 1.5rem; background: #cbd5e1; border-radius: 999px; position: relative; transition: background 0.3s ease; cursor: pointer; }
        .dark .toggle-track { background: #475569; }
        .toggle-input:checked + .toggle-track { background: #2563eb; }
        .dark .toggle-input:checked + .toggle-track { background: #0ea5e9; }
        .toggle-input:checked + .toggle-track .toggle-checkbox { transform: translateX(1.25rem); }
        
        .table-container { max-height: calc(100vh - 300px); overflow-y: auto; scrollbar-width: thin; }
        .table-container::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-container::-webkit-scrollbar-track { background: transparent; }
        .table-container::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        thead th { position: sticky; top: 0; z-index: 10; background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(4px); }
        .dark thead th { background: rgba(30, 41, 59, 0.95); }
        
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15); }

        .sort-icon { display: inline-block; margin-left: 4px; font-size: 0.75rem; color: #94a3b8; cursor: pointer; }
        .sort-icon:hover { color: #475569; }
        .sort-icon.active { color: #2563eb; }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .animate-spin-reverse { animation: spin-reverse 1s linear infinite; }
        @keyframes spin-reverse { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
    </style>
</head>
<body class="antialiased">
<div id="app" class="min-h-screen bg-white dark:bg-slate-950 transition-colors duration-300">
    <transition name="fade">
        <div v-if="loadingState" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white dark:bg-slate-950">
            <div class="relative flex items-center justify-center mb-8">
                <div class="w-20 h-20 rounded-full border-4 border-slate-200 dark:border-slate-700"></div>
                <div class="absolute w-20 h-20 rounded-full border-4 border-transparent border-t-blue-500 animate-spin"></div>
                <i class="fa-solid fa-shield-halved text-2xl text-blue-500 absolute"></i>
            </div>
            
            <div class="flex flex-col items-center">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">AutoProxy</h2>
            </div>
        </div>
    </transition>

    <div v-if="!loadingState">
        <div v-if="canView" class="min-h-screen bg-white dark:bg-slate-950 transition-colors duration-300 flex">
    
            <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 z-30 bg-slate-900/50 backdrop-blur-sm md:hidden transition-opacity"></div>

            <aside :class="[
                sidebarOpen ? 'translate-x-0' : '-translate-x-full',
                desktopSidebarOpen ? 'md:translate-x-0' : 'md:-translate-x-full'
            ]" class="fixed inset-y-0 left-0 z-40 w-64 glass-sidebar flex flex-col flex-shrink-0 shadow-2xl transition-transform duration-300 ease-in-out">
                <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-800">
                    <div class="text-blue-600 dark:text-sky-400 text-2xl mr-2"><i class="fa-solid fa-shield-halved"></i></div>
                    <h1 class="text-xl font-bold tracking-wide text-slate-800 dark:text-slate-100">AutoProxy</h1>
                </div>
                
                <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
                    <a href="#" @click.prevent="currentView = 'dashboard'; sidebarOpen = false" :class="{'active': currentView === 'dashboard'}" class="sidebar-link">
                        <i class="fa-solid fa-chart-pie"></i>
                        <span>{{ t('menu_dashboard') }}</span>
                    </a>
                    <a href="#" @click.prevent="currentView = 'logs'; sidebarOpen = false" :class="{'active': currentView === 'logs'}" class="sidebar-link">
                        <i class="fa-solid fa-list-check"></i>
                        <span>{{ t('menu_logs') }}</span>
                    </a>
                    <a href="#" @click.prevent="currentView = 'settings'; sidebarOpen = false" :class="{'active': currentView === 'settings'}" class="sidebar-link">
                        <i class="fa-solid fa-sliders"></i>
                        <span>{{ t('menu_settings') }}</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                    <div class="flex items-center justify-between mb-3">
                        <a href="https://github.com/Hamster-Prime/DNS_automatic_traffic_splitting" target="_blank" class="text-xs text-slate-500 dark:text-slate-400 font-mono hover:text-blue-600 dark:hover:text-blue-400 transition-colors">latest</a>
                        <button @click="toggleLang" class="text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-sky-400 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 transition-colors uppercase tracking-wider">{{ lang }}</button>
                    </div>
                    <button @click="toggleTheme" class="w-full py-2 px-3 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm flex items-center justify-center transition-colors hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i class="fa-solid mr-2" :class="isDark ? 'fa-sun text-yellow-400' : 'fa-moon text-slate-500'"></i>
                        <span>{{ isDark ? t('theme_light') : t('theme_dark') }}</span>
                    </button>
                </div>
            </aside>

            <div class="flex-1 flex flex-col min-h-screen transition-all duration-300" :class="desktopSidebarOpen ? 'md:pl-64' : 'md:pl-0'">
        <header class="glass-header h-16 flex items-center justify-between px-4 md:px-8 z-20 shadow-sm sticky top-0">
            <div class="flex items-center">
                <button @click="sidebarOpen = !sidebarOpen" class="md:hidden mr-4 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 focus:outline-none">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <button @click="desktopSidebarOpen = !desktopSidebarOpen" class="hidden md:block mr-4 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 focus:outline-none transition-transform" :class="{'rotate-180': !desktopSidebarOpen}">
                    <i class="fa-solid fa-outdent text-xl"></i>
                </button>
                <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">{{ t('menu_' + currentView) }}</h2>
            </div>
            
            <div class="flex items-center space-x-3 md:space-x-6">
                <div class="flex items-center px-3 py-1 bg-green-50 dark:bg-green-950/30 rounded-full border border-green-200 dark:border-green-800 hidden sm:flex">
                    <span class="relative flex h-2 w-2 mr-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="text-sm font-medium text-green-700 dark:text-green-400">{{ t('status_running') }}</span>
                </div>
                
                <button v-if="authEnabled && !isLoggedIn" @click="openLogin" class="btn-glass btn-glass-primary px-4 py-2 rounded-lg shadow-lg text-sm font-medium flex items-center">
                    <i class="fa-solid fa-right-to-bracket mr-2 md:mr-0"></i> <span class="hidden md:inline ml-2">{{ t('login') }}</span>
                </button>
                <button v-if="authEnabled && isLoggedIn" @click="doLogout" class="btn-glass btn-glass-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                    <i class="fa-solid fa-right-from-bracket mr-2 md:mr-0"></i> <span class="hidden md:inline ml-2">{{ t('logout') }}</span>
                </button>

                <button v-if="(currentView === 'settings' || unsavedChanges) && (!authEnabled || isLoggedIn)" @click="saveConfig" :disabled="loading" class="btn-glass btn-glass-primary px-4 py-2 rounded-lg shadow-lg text-sm font-medium flex items-center disabled:opacity-50" :class="{'animate-pulse': unsavedChanges}">
                    <i class="fa-solid fa-save mr-2 md:mr-0"></i> <span class="hidden md:inline ml-2">{{ loading ? t('saving') : t('save_apply') }}</span>
                </button>
                <span v-if="unsavedChanges" class="text-xs font-bold text-amber-500 dark:text-amber-400 mr-2 hidden md:inline-block">{{ t('unsaved_changes') }}</span>
                
                <button v-if="currentView === 'logs'" @click="fetchLogs(1)" class="btn-glass btn-glass-secondary px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                    <i class="fa-solid fa-rotate mr-2"></i> <span class="hidden md:inline">{{ t('refresh') }}</span>
                </button>
            </div>
        </header>

        <main class="flex-1 p-4 md:p-8">
            
            <div v-if="currentView === 'dashboard'" class="space-y-8 animate-fade-in">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div class="stat-card glass-card rounded-2xl p-6 relative overflow-hidden group">
                                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-blue-100 dark:bg-blue-900/20 opacity-50 blur-2xl transition-all group-hover:scale-110"></div>
                                        <div class="absolute top-6 right-6 text-blue-500/20 text-4xl"><i class="fa-solid fa-database"></i></div>
                                        <div class="relative z-10">
                                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">{{ t('stats_total_queries') }}</p>
                                            <div class="flex items-end mb-4">
                                                <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">{{ formatNumber(stats.total_queries) }}</h3>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2 border border-blue-100 dark:border-blue-800/30">
                                                    <div class="text-xs text-blue-600 dark:text-blue-400 font-medium mb-1">CN</div>
                                                    <div class="text-sm font-bold text-slate-700 dark:text-slate-200">{{ formatNumber(stats.total_cn) }}</div>
                                                </div>
                                                <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-2 border border-indigo-100 dark:border-indigo-800/30">
                                                    <div class="text-xs text-indigo-600 dark:text-indigo-400 font-medium mb-1">Overseas</div>
                                                    <div class="text-sm font-bold text-slate-700 dark:text-slate-200">{{ formatNumber(stats.total_overseas) }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card glass-card rounded-2xl p-6 relative overflow-hidden group">
                                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-purple-100 dark:bg-purple-900/20 opacity-50 blur-2xl transition-all group-hover:scale-110"></div>
                                        <div class="absolute top-6 right-6 text-purple-500/20 text-4xl"><i class="fa-solid fa-microchip"></i></div>
                                        <div class="relative z-10">
                                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">{{ t('stats_memory') }}</p>
                                            <div class="flex items-end mb-4">
                                                <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">{{ stats.memory_usage_mb?.toFixed(1) }} <span class="text-lg font-medium text-slate-400">MB</span></h3>
                                            </div>
                                            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-2 border border-purple-100 dark:border-purple-800/30">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-xs text-purple-600 dark:text-purple-400 font-medium">Goroutines</span>
                                                    <span class="text-sm font-bold text-slate-700 dark:text-slate-200 font-mono">{{ stats.num_goroutines }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                
                                    <div class="stat-card glass-card rounded-2xl p-6 relative overflow-hidden group">
                                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-green-100 dark:bg-green-900/20 opacity-50 blur-2xl transition-all group-hover:scale-110"></div>
                                        <div class="absolute top-6 right-6 text-green-500/20 text-4xl"><i class="fa-solid fa-stopwatch"></i></div>
                                        <div class="relative z-10">
                                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">{{ t('stats_uptime') }}</p>
                                            <div class="flex items-end mb-4">
                                                <h3 class="text-3xl font-bold text-slate-800 dark:text-slate-100">{{ formatUptime(stats.uptime_seconds) }}</h3>
                                            </div>
                                            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-2 border border-green-100 dark:border-green-800/30">
                                                <div class="text-xs text-green-600 dark:text-green-400 font-medium mb-1">Started At</div>
                                                <div class="text-xs font-bold text-slate-700 dark:text-slate-200 font-mono truncate">{{ getStartTime(stats.uptime_seconds) }}</div>
                                            </div>
                                        </div>
                                    </div>
                
                                    <div class="stat-card glass-card rounded-2xl p-6 relative overflow-hidden group">
                                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-orange-100 dark:bg-orange-900/20 opacity-50 blur-2xl transition-all group-hover:scale-110"></div>
                                        <div class="absolute top-6 right-6 text-orange-500/10 text-4xl pointer-events-none"><i class="fa-solid fa-network-wired"></i></div>
                                        <div class="relative z-10">
                                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">{{ t('stats_ports') }}</p>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div class="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50">
                                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">TCP</span>
                                                    <span v-if="stats.listen_dns_tcp" class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">{{ formatListenPort(stats.listen_dns_tcp) }}</span>
                                                    <span v-else class="text-xs text-slate-400 dark:text-slate-600">{{ t('not_listening') }}</span>
                                                </div>
                                                <div class="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50">
                                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">UDP</span>
                                                    <span v-if="stats.listen_dns_udp" class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">{{ formatListenPort(stats.listen_dns_udp) }}</span>
                                                    <span v-else class="text-xs text-slate-400 dark:text-slate-600">{{ t('not_listening') }}</span>
                                                </div>
                                                <div class="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50">
                                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">DoH</span>
                                                    <span v-if="stats.listen_doh" class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">{{ formatListenPort(stats.listen_doh) }}</span>
                                                    <span v-else class="text-xs text-slate-400 dark:text-slate-600">{{ t('not_listening') }}</span>
                                                </div>
                                                <div class="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50">
                                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">DoT</span>
                                                    <span v-if="stats.listen_dot" class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">{{ formatListenPort(stats.listen_dot) }}</span>
                                                    <span v-else class="text-xs text-slate-400 dark:text-slate-600">{{ t('not_listening') }}</span>
                                                </div>
                                                <div class="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700/50 col-span-2">
                                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">DoQ</span>
                                                    <span v-if="stats.listen_doq" class="font-mono font-bold text-sm text-slate-700 dark:text-slate-200">{{ formatListenPort(stats.listen_doq) }}</span>
                                                    <span v-else class="text-xs text-slate-400 dark:text-slate-600">{{ t('not_listening') }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="absolute top-6 right-6 text-orange-500/10 text-4xl pointer-events-none"><i class="fa-solid fa-network-wired"></i></div>
                                    </div>
                                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center"><i class="fa-solid fa-chart-pie mr-2 text-blue-500"></i> {{ t('stats_traffic_distribution') }}</h3>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="font-medium text-slate-700 dark:text-slate-300 flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> CN (Domestic)</span>
                                    <span class="font-bold text-slate-900 dark:text-white">{{ stats.total_cn }}</span>
                                </div>
                                <div class="w-full bg-slate-100 dark:bg-slate-800 rounded-full h-3 overflow-hidden">
                                    <div class="bg-green-500 h-3 rounded-full transition-all duration-1000 ease-out" :style="{width: getPercentage(stats.total_cn, stats.total_queries) + '%'}"></div>
                                </div>
                                <div class="text-right text-xs text-slate-500 mt-1">{{ getPercentage(stats.total_cn, stats.total_queries) }}%</div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="font-medium text-slate-700 dark:text-slate-300 flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span> Overseas</span>
                                    <span class="font-bold text-slate-900 dark:text-white">{{ stats.total_overseas }}</span>
                                </div>
                                <div class="w-full bg-slate-100 dark:bg-slate-800 rounded-full h-3 overflow-hidden">
                                    <div class="bg-blue-500 h-3 rounded-full transition-all duration-1000 ease-out" :style="{width: getPercentage(stats.total_overseas, stats.total_queries) + '%'}"></div>
                                </div>
                                <div class="text-right text-xs text-slate-500 mt-1">{{ getPercentage(stats.total_overseas, stats.total_queries) }}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6 lg:col-span-2 flex flex-col">
                         <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center"><i class="fa-solid fa-server mr-2 text-blue-500"></i> {{ t('stats_upstream_perf') }}</h3>
                         
                         <div class="overflow-auto flex-1 max-h-96 pr-2 custom-scrollbar">
                            <table class="min-w-full text-sm text-left">
                                <thead class="text-slate-500 dark:text-slate-400 sticky top-0 z-10">
                                    <tr>
                                        <th class="py-3 px-3 font-medium rounded-l-lg">{{ t('table_server') }}</th>
                                        <th class="py-3 px-3 font-medium">{{ t('table_group') }}</th>
                                        <th class="py-3 px-3 text-right font-medium">{{ t('table_queries') }}</th>
                                        <th class="py-3 px-3 text-right font-medium">{{ t('table_errors') }}</th>
                                        <th class="py-3 px-3 text-right font-medium">{{ t('table_canceled') }}</th>
                                        <th class="py-3 px-3 text-right font-medium rounded-r-lg">{{ t('table_avg_time') }}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                    <tr v-for="s in stats.upstream_stats" :key="s.address" class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                        <td class="py-3 px-3 font-mono text-xs text-slate-600 dark:text-slate-300 truncate max-w-[150px]" :title="s.address">{{ s.address }} <span class="text-[10px] text-slate-400 ml-1 uppercase">{{ s.protocol }}</span></td>
                                        <td class="py-3 px-3">
                                            <span class="px-2 py-0.5 rounded-md text-xs font-medium border" :class="s.group === 'CN' ? 'bg-green-50 text-green-700 border-green-200 dark:bg-green-950/30 dark:text-green-300 dark:border-green-800' : 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-950/30 dark:text-blue-300 dark:border-blue-800'">{{ s.group }}</span>
                                        </td>
                                        <td class="py-3 px-3 text-right font-mono text-slate-700 dark:text-slate-300">{{ s.total_queries }}</td>
                                        <td class="py-3 px-3 text-right font-mono text-red-500 font-medium">{{ s.total_errors > 0 ? s.total_errors : '-' }}</td>
                                        <td class="py-3 px-3 text-right font-mono text-slate-400">{{ s.total_canceled > 0 ? s.total_canceled : '-' }}</td>
                                        <td class="py-3 px-3 text-right font-mono font-medium" :class="getLatencyClass(s.avg_duration_ms)">{{ s.avg_duration_ms }} ms</td>
                                    </tr>
                                </tbody>
                            </table>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="glass-card rounded-2xl p-6" v-if="sortedTopClients.length > 0">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center"><i class="fa-solid fa-users mr-2 text-blue-500"></i> {{ t('top_clients') }}</h3>
                        <ul class="space-y-3">
                            <li v-for="(client, idx) in sortedTopClients.slice(0, 5)" :key="client[0]" class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-lg transition-colors">
                                <div class="flex items-center overflow-hidden">
                                    <span class="text-slate-400 font-mono mr-3 w-4 text-right">{{ idx + 1 }}</span>
                                    <span class="text-slate-700 dark:text-slate-300 font-medium truncate" :title="client[0]">{{ client[0] }}</span>
                                </div>
                                <span class="font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded text-xs">{{ client[1] }}</span>
                            </li>
                        </ul>
                     </div>
                     
                     <div class="glass-card rounded-2xl p-6" v-if="sortedTopDomains.length > 0">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center"><i class="fa-solid fa-globe mr-2 text-purple-500"></i> {{ t('top_domains') }}</h3>
                        <ul class="space-y-3">
                            <li v-for="(domain, idx) in sortedTopDomains.slice(0, 5)" :key="domain[0]" class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-lg transition-colors">
                                <div class="flex items-center overflow-hidden">
                                    <span class="text-slate-400 font-mono mr-3 w-4 text-right">{{ idx + 1 }}</span>
                                    <span class="text-slate-700 dark:text-slate-300 font-medium truncate" :title="domain[0]">{{ domain[0] }}</span>
                                </div>
                                <span class="font-mono font-bold text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20 px-2 py-1 rounded text-xs">{{ domain[1] }}</span>
                            </li>
                        </ul>
                     </div>
                </div>
            </div>

            <div v-if="currentView === 'logs'" class="glass-card rounded-2xl flex flex-col h-full overflow-hidden animate-fade-in shadow-lg">
                <div class="p-4 border-b border-slate-200 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/80 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center gap-2 text-slate-700 dark:text-slate-200">
                         <i class="fa-solid fa-list-ul"></i> <span class="font-medium">{{ t('logs_title') }}</span>
                    </div>
                    <div class="flex gap-2 w-full max-w-md">
                        <div class="relative flex-1">
                            <input v-model="logsFilter" :placeholder="t('filter_logs_placeholder')" @keyup.enter="fetchLogs(1)" class="w-full border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white rounded-lg pl-9 pr-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all placeholder-slate-400">
                            <i class="fa-solid fa-search absolute left-3 top-2 text-slate-400 text-xs"></i>
                        </div>
                        <button @click="fetchLogs(1)" class="btn-glass btn-glass-primary px-3 py-1.5 rounded-lg text-sm shadow-sm transition-colors">{{ t('search') }}</button>
                    </div>
                </div>
                <div class="flex-1 table-container bg-white dark:bg-slate-950">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800 text-sm">
                        <thead class="text-slate-500 dark:text-slate-400">
                            <tr>
                                <th @click="sortBy('time')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_time') }} <i class="sort-icon fa-solid" :class="getSortIcon('time')"></i>
                                </th>
                                <th @click="sortBy('client_ip')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_client') }} <i class="sort-icon fa-solid" :class="getSortIcon('client_ip')"></i>
                                </th>
                                <th @click="sortBy('domain')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_domain') }} <i class="sort-icon fa-solid" :class="getSortIcon('domain')"></i>
                                </th>
                                <th @click="sortBy('type')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_type') }} <i class="sort-icon fa-solid" :class="getSortIcon('type')"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">
                                    {{ t('log_answer') }}
                                </th>
                                <th @click="sortBy('upstream')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_upstream') }} <i class="sort-icon fa-solid" :class="getSortIcon('upstream')"></i>
                                </th>
                                <th @click="sortBy('status')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_status') }} <i class="sort-icon fa-solid" :class="getSortIcon('status')"></i>
                                </th>
                                <th @click="sortBy('duration_ms')" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer select-none hover:text-slate-700 dark:hover:text-slate-200 group">
                                    {{ t('log_duration') }} <i class="sort-icon fa-solid" :class="getSortIcon('duration_ms')"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                            <tr v-for="log in sortedLogs" :key="log.id" class="hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer" @click="showLogDetails(log)">
                                <td class="px-4 py-2 whitespace-nowrap text-slate-500 dark:text-slate-400 font-mono text-xs">{{ formatTime(log.time) }}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-blue-600 dark:text-blue-400 font-medium" @click.stop="logsFilter = log.client_ip; fetchLogs(1)">{{ log.client_ip }}</td>
                                <td class="px-4 py-2 text-slate-800 dark:text-slate-200 font-medium break-all">{{ log.domain }}</td>
                                <td class="px-4 py-2 text-slate-500 dark:text-slate-400 text-xs">{{ log.type }}</td>
                                <td class="px-4 py-2 text-slate-600 dark:text-slate-300 font-mono text-xs truncate max-w-[200px]" :title="log.answer">{{ log.answer }}</td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <span class="px-2 py-0.5 inline-flex text-xs leading-4 font-medium rounded-full" :class="getUpstreamClass(log.upstream)">
                                        {{ log.upstream }}
                                    </span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold" :class="log.status === 'NOERROR' ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300'">{{ log.status }}</span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap text-slate-500 dark:text-slate-400 font-mono text-xs">{{ log.duration_ms }}ms</td>
                            </tr>
                            <tr v-if="logs.length === 0">
                                <td colspan="8" class="px-4 py-12 text-center text-slate-400">
                                    <i class="fa-solid fa-inbox text-4xl mb-3 opacity-30"></i>
                                    <p>{{ t('no_logs') }}</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/80 flex justify-between items-center backdrop-blur-sm">
                     <div class="text-sm text-slate-500 dark:text-slate-400">
                         Showing <span class="font-medium">{{ (logsPage - 1) * 15 + 1 }}</span> to <span class="font-medium">{{ Math.min(logsPage * 15, logsTotal) }}</span> of <span class="font-medium">{{ logsTotal }}</span> results
                     </div>
                     <div class="flex space-x-2">
                         <button @click="fetchLogs(logsPage - 1)" :disabled="logsPage <= 1" class="btn-glass bg-white/50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-lg text-sm hover:bg-white/80 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                             {{ t('prev') }}
                         </button>
                         <button @click="fetchLogs(logsPage + 1)" :disabled="logsPage * 15 >= logsTotal" class="btn-glass bg-white/50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-lg text-sm hover:bg-white/80 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                             {{ t('next') }}
                         </button>
                     </div>
                 </div>
            </div>

            <div v-if="currentView === 'settings'" class="space-y-8 max-w-5xl mx-auto pb-10 animate-fade-in">
            
                 <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                        <i class="fa-solid fa-user-shield text-slate-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">WebUI Settings</h3>
                    </div>
                    <div class="p-6 space-y-6 bg-white dark:bg-slate-950">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800">
                            <form-input :label="t('username')" v-model="config.web_ui.username" :disabled="!canEdit"></form-input>
                            <form-input :label="t('password')" v-model="config.web_ui.password" type="password" :disabled="!canEdit"></form-input>
                            <div class="md:col-span-2 mt-2">
                                <toggle-switch :label="t('setting_guest_mode')" v-model="config.web_ui.guest_mode" :disabled="!canEdit"></toggle-switch>
                                <p class="text-xs text-slate-500 mt-1 ml-1">Allow viewing dashboard without login. Login required for changes.</p>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                        <i class="fa-solid fa-database text-slate-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_querylog') }}</h3>
                    </div>
                    <div class="p-6 space-y-6 bg-white dark:bg-slate-950">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800">
                            <div class="flex flex-col space-y-4">
                                <toggle-switch :label="t('setting_save_file')" v-model="config.query_log.save_to_file" :disabled="!canEdit"></toggle-switch>
                                <div v-if="config.query_log.save_to_file">
                                     <form-input :label="t('setting_log_path')" v-model="config.query_log.file" placeholder="query.log" class="transition-all" :disabled="!canEdit"></form-input>
                                     <p class="text-xs text-slate-500 mt-1">Defaults to 'query.log' if empty.</p>
                                </div>
                            </div>
                            <form-input :label="t('setting_log_size')" v-model.number="config.query_log.max_size_mb" type="number" placeholder="1" :disabled="!canEdit"></form-input>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                        <i class="fa-solid fa-network-wired text-slate-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_listen') }}</h3>
                    </div>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-white dark:bg-slate-950">
                        <form-input :label="t('dns_udp')" v-model="config.listen.dns_udp" placeholder="53" :disabled="!canEdit"></form-input>
                        <form-input :label="t('dns_tcp')" v-model="config.listen.dns_tcp" placeholder="53" :disabled="!canEdit"></form-input>
                        <form-input :label="t('doh_https')" v-model="config.listen.doh" placeholder="443" :disabled="!canEdit"></form-input>
                        <form-input :label="t('doh_path')" v-model="config.listen.doh_path" placeholder="/dns-query" :disabled="!canEdit"></form-input>
                        <form-input :label="t('dot_tls')" v-model="config.listen.dot" placeholder="853" :disabled="!canEdit"></form-input>
                        <form-input :label="t('doq_quic')" v-model="config.listen.doq" placeholder="853" :disabled="!canEdit"></form-input>
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                        <i class="fa-solid fa-rocket text-slate-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_bootstrap') }}</h3>
                    </div>
                    <div class="p-6 bg-white dark:bg-slate-950">
                        <div v-for="(dns, index) in config.bootstrap_dns" :key="index" class="flex mb-3 items-center">
                            <div class="flex-1">
                                <input type="text" v-model="config.bootstrap_dns[index]" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2.5 border transition-shadow disabled:bg-slate-100 disabled:text-slate-500" placeholder="8.8.8.8:53" :disabled="!canEdit">
                            </div>
                            <button v-if="canEdit" @click="removeBootstrap(index)" class="ml-3 text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 dark:hover:bg-red-950/30 transition-colors"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <button v-if="canEdit" @click="addBootstrap" class="mt-2 flex items-center text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium px-3 py-2 rounded hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"><i class="fa-solid fa-plus mr-1"></i> {{ t('add') }}</button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                        <i class="fa-solid fa-key text-slate-400 mr-3"></i>
                        <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_tls_certs') }}</h3>
                    </div>
                    <div class="p-6 bg-white dark:bg-slate-950">
                        <div v-for="(cert, index) in config.tls_certificates" :key="index" class="flex mb-3 items-start bg-slate-50 dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-800">
                            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <form-input :label="t('cert_file')" v-model="cert.cert_file" placeholder="certs/example.com.crt" :disabled="!canEdit"></form-input>
                                <form-input :label="t('key_file')" v-model="cert.key_file" placeholder="certs/example.com.key" :disabled="!canEdit"></form-input>
                            </div>
                            <button v-if="canEdit" @click="removeTLSCert(index)" class="ml-3 mt-6 text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 dark:hover:bg-red-950/30 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <button v-if="canEdit" @click="addTLSCert" class="mt-2 flex items-center text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium px-3 py-2 rounded hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"><i class="fa-solid fa-plus mr-1"></i> {{ t('add') }}</button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                        <div class="flex items-center">
                            <i class="fa-solid fa-server text-slate-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_upstreams') }}</h3>
                        </div>
                        <div class="flex space-x-2">
                            <button :disabled="!canEdit" @click="toggleSort" class="btn-glass btn-glass-secondary px-3 py-1.5 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center" :class="{'opacity-50 cursor-not-allowed': !canEdit}">
                                <i class="fa-solid fa-sort mr-2"></i> {{ isSorting ? t('sort_done') : t('sort') }}
                            </button>
                            <button :disabled="!canEdit" @click="testUpstreams" class="btn-glass btn-glass-primary px-3 py-1.5 rounded-lg shadow-sm text-sm font-medium transition-all flex items-center" :class="{'opacity-50 cursor-not-allowed': !canEdit}">
                                <i class="fa-solid fa-vial mr-2"></i> {{ t('test_upstreams') }}
                            </button>
                        </div>
                    </div>
                    <div class="p-6 bg-white dark:bg-slate-950">
                        <div class="flex space-x-1 bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-6 w-fit">
                            <button @click="upstreamTab = 'cn'" class="px-4 py-2 rounded-md text-sm font-medium transition-all" :class="upstreamTab === 'cn' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'">{{ t('tab_cn') }}</button>
                            <button @click="upstreamTab = 'overseas'" class="px-4 py-2 rounded-md text-sm font-medium transition-all" :class="upstreamTab === 'overseas' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'">{{ t('tab_overseas') }}</button>
                        </div>

                        <div class="space-y-4">
                            <transition-group name="list" tag="div" class="space-y-4">
                                <div v-for="(server, index) in currentUpstreams" :key="server._id" 
                                    class="bg-slate-50 dark:bg-slate-900 rounded-xl p-5 border border-slate-200 dark:border-slate-800 relative group hover:border-blue-300 dark:hover:border-blue-700 transition-colors"
                                    :class="{'cursor-move': isSorting, 'dragging': draggedIndex === index}"
                                    :draggable="isSorting"
                                    @dragstart="onDragStart(index, $event)"
                                    @dragover.prevent
                                    @dragenter="onDragEnter(index)"
                                    @dragend="onDragEnd"
                                >
                                    <div v-if="!isSorting" class="absolute top-3 right-3 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button v-if="canEdit" @click="removeUpstream(upstreamTab, index)" class="text-slate-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white dark:hover:bg-slate-800 shadow-sm" title="Delete">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                    <div v-if="isSorting" class="absolute top-3 right-3 text-slate-400">
                                        <i class="fa-solid fa-grip-lines"></i>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 items-end" :class="{'pointer-events-none opacity-80': isSorting}">
                                        <form-input :label="t('address')" v-model="server.address" placeholder="1.1.1.1:53" :disabled="!canEdit" input-class="h-10"></form-input>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">{{ t('protocol') }}</label>
                                            <select :disabled="!canEdit" v-model="server.protocol" class="block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-slate-700 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg border shadow-sm bg-white dark:bg-slate-950 dark:text-white disabled:bg-slate-100 disabled:text-slate-500 h-10 transition-all">
                                                <option value="udp">UDP</option>
                                                <option value="tcp">TCP</option>
                                                <option value="doh">DoH</option>
                                                <option value="dot">DoT</option>
                                                <option value="doq">DoQ</option>
                                            </select>
                                        </div>
                                        <form-input :label="t('ecs_ip')" v-model="server.ecs_ip" placeholder="Client Subnet IP" :disabled="!canEdit" input-class="h-10"></form-input>
                                    </div>
                                    <div class="mt-4 flex flex-wrap gap-6 pt-4 border-t border-slate-200 dark:border-slate-800" :class="{'pointer-events-none opacity-80': isSorting}">
                                        <toggle-switch v-if="showPipeline(server.protocol)" label="Pipeline" v-model="server.pipeline" :disabled="!canEdit"></toggle-switch>
                                        <toggle-switch v-if="showH3(server.protocol)" label="HTTP/3" v-model="server.http3" :disabled="!canEdit"></toggle-switch>
                                        <toggle-switch v-if="showVerify(server.protocol)" label="Skip Verify" v-model="server.insecure_skip_verify" :disabled="!canEdit"></toggle-switch>
                                    </div>
                                </div>
                            </transition-group>
                            <button v-if="canEdit && !isSorting" @click="addUpstream(upstreamTab)" class="w-full py-3 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl text-slate-500 dark:text-slate-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all font-medium flex items-center justify-center"><i class="fa-solid fa-plus-circle mr-2"></i> {{ t('add_server') }}</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card rounded-2xl overflow-hidden flex flex-col">
                        <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa-solid fa-book-atlas text-slate-400 mr-3"></i>
                                <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_hosts') }}</h3>
                            </div>
                            <button v-if="canEdit" @click="hostsArray.push({ip:'', domain:''})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 w-8 h-8 rounded-full flex items-center justify-center transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="p-6 bg-white dark:bg-slate-950 flex-1 overflow-y-auto max-h-[400px] space-y-3 custom-scrollbar">
                            <div v-if="hostsArray.length === 0" class="text-center py-8 text-slate-400 dark:text-slate-600 text-sm italic">{{ t('no_records') }}</div>
                            <div v-for="(h, i) in hostsArray" :key="i" class="flex items-center space-x-3 group">
                                <div class="flex-1 bg-slate-50 dark:bg-slate-900 rounded-lg p-1 border border-transparent group-hover:border-slate-200 dark:group-hover:border-slate-800 transition-all flex items-center">
                                    <div class="px-2 text-slate-400"><i class="fa-solid fa-network-wired text-xs"></i></div>
                                    <input v-model="h.ip" :placeholder="t('ip')" :disabled="!canEdit" class="bg-transparent border-none focus:ring-0 text-sm w-full py-1.5 text-slate-700 dark:text-slate-200 placeholder-slate-400 font-mono">
                                </div>
                                <div class="text-slate-300 dark:text-slate-600"><i class="fa-solid fa-arrow-right text-xs"></i></div>
                                <div class="flex-1 bg-slate-50 dark:bg-slate-900 rounded-lg p-1 border border-transparent group-hover:border-slate-200 dark:group-hover:border-slate-800 transition-all flex items-center">
                                    <div class="px-2 text-slate-400"><i class="fa-solid fa-globe text-xs"></i></div>
                                    <input v-model="h.domain" :placeholder="t('domain')" :disabled="!canEdit" class="bg-transparent border-none focus:ring-0 text-sm w-full py-1.5 text-slate-700 dark:text-slate-200 placeholder-slate-400 font-mono">
                                </div>
                                <button v-if="canEdit" @click="hostsArray.splice(i, 1)" class="text-slate-300 hover:text-red-500 w-8 h-8 flex justify-center items-center rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl overflow-hidden flex flex-col">
                        <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa-solid fa-filter text-slate-400 mr-3"></i>
                                <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">{{ t('setting_rules') }}</h3>
                            </div>
                            <button v-if="canEdit" @click="rulesArray.push({domain:'', target:'overseas'})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 w-8 h-8 rounded-full flex items-center justify-center transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="p-6 bg-white dark:bg-slate-950 flex-1 overflow-y-auto max-h-[400px] space-y-3 custom-scrollbar">
                            <p class="text-xs text-slate-500 mb-3 flex items-center bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-100 dark:border-blue-800/30 text-blue-600 dark:text-blue-400"><i class="fa-solid fa-circle-info mr-2"></i> {{ t('rule_help') }}</p>
                            <div v-if="rulesArray.length === 0" class="text-center py-8 text-slate-400 dark:text-slate-600 text-sm italic">{{ t('no_records') }}</div>
                            <div v-for="(r, i) in rulesArray" :key="i" class="flex items-center space-x-3 group">
                                <div class="flex-[2] bg-slate-50 dark:bg-slate-900 rounded-lg p-1 border border-transparent group-hover:border-slate-200 dark:group-hover:border-slate-800 transition-all flex items-center">
                                    <div class="px-2 text-slate-400"><i class="fa-solid fa-globe text-xs"></i></div>
                                    <input v-model="r.domain" :placeholder="t('domain')" :disabled="!canEdit" class="bg-transparent border-none focus:ring-0 text-sm w-full py-1.5 text-slate-700 dark:text-slate-200 placeholder-slate-400 font-mono">
                                </div>
                                <div class="text-slate-300 dark:text-slate-600"><i class="fa-solid fa-arrow-right text-xs"></i></div>
                                <div class="flex-1">
                                    <select v-model="r.target" :disabled="!canEdit" class="block w-full border-slate-300 dark:border-slate-700 rounded-lg py-1.5 pl-2 pr-8 bg-slate-50 dark:bg-slate-900 dark:text-white shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-medium border-transparent group-hover:border-slate-200 dark:group-hover:border-slate-800">
                                        <option value="cn">CN</option>
                                        <option value="overseas">Overseas</option>
                                    </select>
                                </div>
                                <button v-if="canEdit" @click="rulesArray.splice(i, 1)" class="text-slate-300 hover:text-red-500 w-8 h-8 flex justify-center items-center rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                            <i class="fa-solid fa-earth-asia text-slate-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">Geo Data</h3>
                        </div>
                        <div class="p-6 space-y-5 bg-white dark:bg-slate-950">
                            <form-input label="GeoIP File" v-model="config.geo_data.geoip_dat" :disabled="!canEdit"></form-input>
                            <form-input label="GeoSite File" v-model="config.geo_data.geosite_dat" :disabled="!canEdit"></form-input>
                            <form-input label="GeoIP URL" v-model="config.geo_data.geoip_download_url" class="text-sm" :disabled="!canEdit"></form-input>
                            <form-input label="GeoSite URL" v-model="config.geo_data.geosite_download_url" class="text-sm" :disabled="!canEdit"></form-input>
                            <form-input :label="t('auto_update')" v-model="config.geo_data.auto_update" placeholder="04:00" :disabled="!canEdit"></form-input>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="bg-slate-50/80 dark:bg-slate-900/80 px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center">
                            <i class="fa-solid fa-certificate text-slate-400 mr-3"></i>
                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">Auto Certificate (ACME)</h3>
                        </div>
                        <div class="p-6 space-y-5 bg-white dark:bg-slate-950">
                            <toggle-switch label="Enable AutoCert" v-model="config.auto_cert.enabled" :disabled="!canEdit"></toggle-switch>
                            <template v-if="config.auto_cert.enabled">
                                <form-input label="Email" v-model="config.auto_cert.email" :disabled="!canEdit"></form-input>
                                <div class="mb-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Domains</label>
                                    <div v-for="(d, i) in config.auto_cert.domains" :key="i" class="flex mb-2">
                                        <input v-model="config.auto_cert.domains[i]" class="flex-1 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white p-2.5 text-sm border shadow-sm" placeholder="example.com" :disabled="!canEdit">
                                        <button v-if="canEdit" @click="config.auto_cert.domains.splice(i, 1)" class="ml-2 text-red-400 hover:text-red-600 w-8 flex justify-center items-center"><i class="fa-solid fa-times"></i></button>
                                    </div>
                                    <button v-if="canEdit" @click="config.auto_cert.domains.push('')" class="mt-1 text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium flex items-center"><i class="fa-solid fa-plus mr-1"></i> Add Domain</button>
                                </div>
                                <form-input label="Cert Storage Dir" v-model="config.auto_cert.cert_dir" :disabled="!canEdit"></form-input>
                            </template>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>
        
        <div v-else class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-slate-900 px-4">
            <div class="max-w-md w-full space-y-8 glass-card p-8 rounded-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 rounded-full bg-blue-100 dark:bg-blue-900/20 opacity-50 blur-3xl pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 rounded-full bg-purple-100 dark:bg-purple-900/20 opacity-50 blur-3xl pointer-events-none"></div>
                
                <div class="text-center relative z-10">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 dark:bg-blue-900/20 mb-4">
                        <i class="fa-solid fa-shield-halved text-3xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">AutoProxy</h2>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">System Dashboard</p>
                </div>
                
                <form class="mt-8 space-y-6 relative z-10" @submit.prevent="doLogin">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">{{ t('username') }}</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <input type="text" v-model="loginForm.username" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-950 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">{{ t('password') }}</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="fa-solid fa-lock"></i>
                                </div>
                                <input type="password" v-model="loginForm.password" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-950 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-all" required>
                            </div>
                        </div>
                    </div>

                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2.5 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all">
                            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                <i class="fa-solid fa-right-to-bracket text-blue-200 group-hover:text-blue-100"></i>
                            </span>
                            {{ t('login') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <modal :show="modal.show" :title="modal.title" :max-width="modal.maxWidth" @close="modal.show = false">
            <div v-if="modal.type === 'saving'" class="flex flex-col items-center justify-center py-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-slate-600 dark:text-slate-400">{{ t('saving') }}</p>
            </div>
            
            <div v-if="modal.type === 'saved'" class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900/50 mb-4">
                    <i class="fa-solid fa-check text-green-600 dark:text-green-400 text-xl"></i>
                </div>
                <p class="text-sm text-slate-500 dark:text-slate-400">{{ t('saved_msg') }}</p>
            </div>
            
            <div v-if="modal.type === 'testing'" class="flex flex-col items-center justify-center py-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-slate-600 dark:text-slate-400">{{ t('testing') }}</p>
            </div>
            
            <div v-if="modal.type === 'test'" class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700 text-sm">
                    <thead class="bg-slate-50 dark:bg-slate-800 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-slate-500 dark:text-slate-400">Address</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-500 dark:text-slate-400">Protocol</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-500 dark:text-slate-400">Group</th>
                            <th class="px-3 py-2 text-right font-medium text-slate-500 dark:text-slate-400">Status</th>
                            <th class="px-3 py-2 text-right font-medium text-slate-500 dark:text-slate-400">Latency</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-700">
                        <tr v-for="(res, i) in modal.testResults" :key="i">
                            <td class="px-3 py-2 truncate max-w-[200px] text-slate-800 dark:text-slate-200" :title="res.address">{{ res.address }}</td>
                             <td class="px-3 py-2 text-slate-800 dark:text-slate-200"><span class="px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 text-xs font-mono">{{ res.protocol }}</span></td>
                            <td class="px-3 py-2 text-slate-800 dark:text-slate-200">{{ res.group }}</td>
                            <td class="px-3 py-2 text-right" :class="getTestStatusClass(res.status)">
                                {{ res.status }}
                                <i v-if="res.status === 'Error' || res.status === 'Fail'" class="fa-solid fa-circle-exclamation ml-1 text-xs" :title="res.error"></i>
                            </td>
                            <td class="px-3 py-2 text-right font-mono text-slate-800 dark:text-slate-200">{{ res.latency }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-if="modal.type === 'login'" class="space-y-4">
                <form @submit.prevent="doLogin">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ t('username') }}</label>
                        <input type="text" v-model="loginForm.username" class="w-full border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ t('password') }}</label>
                        <input type="password" v-model="loginForm.password" class="w-full border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required>
                    </div>
                    <button type="submit" class="btn-glass btn-glass-primary w-full p-2 rounded-lg shadow-lg transition-colors">{{ t('login') }}</button>
                </form>
            </div>

            <div v-if="modal.type === 'log_details'" class="space-y-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_time') }}</span> <span class="font-mono text-slate-800 dark:text-slate-200">{{ formatTime(modal.log.time) }}</span></div>
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_client') }}</span> <span class="font-mono text-slate-800 dark:text-slate-200">{{ modal.log.client_ip }}</span></div>
                    <div class="col-span-2"><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_domain') }}</span> <span class="font-bold text-lg text-slate-900 dark:text-white break-all">{{ modal.log.domain }}</span></div>
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_type') }}</span> <span class="font-mono bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-800 dark:text-slate-200">{{ modal.log.type }}</span></div>
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_duration') }}</span> <span class="font-mono text-slate-800 dark:text-slate-200">{{ modal.log.duration_ms }}ms</span></div>
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_status') }}</span> <span class="font-bold" :class="modal.log.status === 'NOERROR' ? 'text-green-600' : 'text-red-600'">{{ modal.log.status }}</span></div>
                    <div><span class="text-slate-500 dark:text-slate-400 block text-xs uppercase">{{ t('log_upstream') }}</span> <span class="font-medium text-blue-600 dark:text-blue-400">{{ modal.log.upstream }}</span></div>
                </div>
                
                <div class="border-t border-slate-200 dark:border-slate-800 pt-4">
                     <h4 class="text-sm font-bold text-slate-800 dark:text-slate-100 mb-3 uppercase tracking-wide">{{ t('resolution_chain') }}</h4>
                     <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 space-y-3 relative">
                        <div class="absolute top-4 bottom-4 left-6 w-0.5 bg-slate-200 dark:bg-slate-700"></div>
                        
                        <div class="relative flex items-start">
                            <div class="relative z-10 w-4 h-4 rounded-full bg-blue-500 border-2 border-white dark:border-slate-900 mt-1 mr-4 shrink-0"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-slate-500 dark:text-slate-400">Question</p>
                                <p class="font-mono text-sm font-medium text-slate-800 dark:text-slate-200 break-all">{{ modal.log.domain }}</p>
                            </div>
                        </div>

                        <div v-for="(rec, i) in modal.log.answer_records" :key="i" class="relative flex items-start">
                            <div class="relative z-10 w-4 h-4 rounded-full border-2 border-white dark:border-slate-900 mt-1 mr-4 shrink-0" :class="rec.type === 'CNAME' ? 'bg-purple-500' : 'bg-green-500'"></div>
                             <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold px-1.5 py-0.5 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">{{ rec.type }}</span>
                                    <span class="text-xs text-slate-400">TTL {{ rec.ttl }}</span>
                                </div>
                                <p class="font-mono text-sm text-slate-700 dark:text-slate-300 mt-0.5 break-all">{{ rec.data }}</p>
                            </div>
                        </div>
                        
                        <div v-if="!modal.log.answer_records || modal.log.answer_records.length === 0" class="relative flex items-start">
                             <div class="relative z-10 w-4 h-4 rounded-full bg-slate-400 border-2 border-white dark:border-slate-900 mt-1 mr-4 shrink-0"></div>
                             <div class="flex-1 min-w-0">
                                <p class="text-sm text-slate-500 italic">{{ modal.log.answer || 'No Answer' }}</p>
                            </div>
                        </div>
                     </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button v-if="!isBlocked(modal.log.domain)" @click="blockDomain(modal.log.domain)" class="btn-glass bg-red-500/10 text-red-600 border-red-500/20 hover:bg-red-500/20 px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-all">
                        <i class="fa-solid fa-ban mr-2"></i> {{ t('block_domain') }}
                    </button>
                    <button v-else @click="unblockDomain(modal.log.domain)" class="btn-glass bg-green-500/10 text-green-600 border-green-500/20 hover:bg-green-500/20 px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-all">
                        <i class="fa-solid fa-check mr-2"></i> {{ t('unblock_domain') }}
                    </button>
                </div>
            </div>

            <template #footer>
                <button v-if="modal.type === 'saved'" @click="reloadPage" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    {{ t('ok') }}
                </button>
                <button v-if="modal.type !== 'saved' && modal.type !== 'saving' && modal.type !== 'testing' && modal.type !== 'login'" @click="modal.show = false" type="button" class="w-full inline-flex justify-center rounded-md border border-slate-300 dark:border-slate-700 shadow-sm px-4 py-2 bg-white dark:bg-slate-800 text-base font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {{ t('ok') }}
                </button>
            </template>
        </modal>
    </div>
</div>

<script>
const i18nData = {
    zh: {
        menu_dashboard: "",
        menu_logs: "",
        menu_settings: "",
        status_running: "",
        save_apply: "",
        saving: "...",
        refresh: "",
        search: "",
        disabled: "",
        stats_total_queries: "",
        stats_memory: "",
        stats_uptime: "",
        stats_ports: "",
        stats_traffic_distribution: "",
        stats_upstream_perf: "",
        top_clients: "",
        top_domains: "",
        logs_title: "",
        filter_logs_placeholder: " IP /  /  / ...",
        log_time: "",
        log_client: "",
        log_domain: "",
        log_type: "",
        log_upstream: "",
        log_answer: "",
        log_status: "",
        log_duration: "",
        no_logs: "",
        setting_querylog: "",
        setting_listen: "",
        setting_bootstrap: "Bootstrap DNS",
        setting_upstreams: " DNS ",
        setting_hosts: " Hosts",
        setting_rules: "",
        setting_guest_mode: "",
        setting_tls_certs: "TLS ",
        setting_log_size: " (MB)",
        setting_save_file: "",
        setting_log_path: "",
        tab_cn: "",
        tab_overseas: "",
        address: "",
        protocol: "",
        ecs_ip: "ECS IP",
        domain: "",
        ip: "IP ",
        target: "",
        auto_update: " (HH:MM)",
        rule_help: " ( regexp: )",
        add: "",
        add_server: "",
        test_upstreams: "",
        test_results: "",
        testing: "...",
        saving_title: "",
        saved_title: "",
        saved_msg: "",
        ok: "",
        latency: "",
        status: "",
        dns_udp: "DNS UDP",
        dns_tcp: "DNS TCP",
        doh_https: "DoH Port",
        doh_path: "DoH Path",
        dot_tls: "DoT",
        doq_quic: "DoQ",
        cert_file: " (.crt)",
        key_file: " (.key)",
        table_server: "",
        table_group: "",
        table_queries: "",
        table_errors: "",
        table_canceled: "/",
        table_avg_time: "",
        login: "",
        logout: "",
        username: "",
        password: "",
        login_title: "",
        login_fail: "",
        theme_light: "",
        theme_dark: "",
        sort: "",
        sort_done: "",
        not_listening: "",
        unsaved_changes: "",
        log_details: "",
        resolution_chain: "",
        block_domain: "",
        unblock_domain: "",
        blocked_msg: " Hosts  '' ",
        unblocked_msg: " Hosts  '' ",
        no_records: "",
        prev: "",
        next: ""
    },
    en: {
        menu_dashboard: "Dashboard",
        menu_logs: "Query Logs",
        menu_settings: "Settings",
        status_running: "Running",
        save_apply: "Save & Apply",
        saving: "Saving...",
        refresh: "Refresh",
        search: "Search",
        disabled: "Disabled",
        stats_total_queries: "Total Queries",
        stats_memory: "Memory",
        stats_uptime: "Uptime",
        stats_ports: "Listening Ports",
        stats_traffic_distribution: "Traffic Split",
        stats_upstream_perf: "Upstream Performance",
        top_clients: "Top Clients",
        top_domains: "Top Domains",
        logs_title: "Query Log",
        filter_logs_placeholder: "Search Client IP / Domain / Type / Status...",
        log_time: "Time",
        log_client: "Client",
        log_domain: "Domain",
        log_type: "Type",
        log_upstream: "Strategy",
        log_answer: "Answer",
        log_status: "Status",
        log_duration: "Duration",
        no_logs: "No logs found",
        setting_querylog: "Query Log",
        setting_listen: "Listening Ports",
        setting_bootstrap: "Bootstrap DNS",
        setting_upstreams: "Upstream Servers",
        setting_hosts: "Custom Hosts",
        setting_rules: "Custom Rules",
        setting_guest_mode: "Enable Guest Mode",
        setting_tls_certs: "TLS Certificates",
        setting_log_size: "Log File Max Size (MB)",
        setting_save_file: "Save to File",
        setting_log_path: "Log File Path",
        tab_cn: "Domestic",
        tab_overseas: "Overseas",
        address: "Address",
        protocol: "Protocol",
        ecs_ip: "ECS IP",
        domain: "Domain",
        ip: "IP Address",
        target: "Target Group",
        auto_update: "Daily Auto Update Time (HH:MM)",
        rule_help: "Regex supported (start with regexp:)",
        add: "Add",
        add_server: "Add Server",
        test_upstreams: "Test All Upstreams",
        test_results: "Test Results",
        testing: "Testing Connectivity...",
        saving_title: "Saving Configuration",
        saved_title: "Saved Successfully",
        saved_msg: "Configuration saved and applied. Click OK to refresh.",
        ok: "OK",
        latency: "Latency",
        status: "Status",
        dns_udp: "DNS UDP",
        dns_tcp: "DNS TCP",
        doh_https: "DoH Port",
        doh_path: "DoH Path",
        dot_tls: "DoT",
        doq_quic: "DoQ",
        cert_file: "Cert File (.crt)",
        key_file: "Key File (.key)",
        table_server: "Server",
        table_group: "Group",
        table_queries: "Queries",
        table_errors: "Errors",
        table_canceled: "Canceled",
        table_avg_time: "Avg Time",
        login: "Login",
        logout: "Logout",
        username: "Username",
        password: "Password",
        login_title: "Admin Login",
        login_fail: "Login failed, check credentials",
        theme_light: "Light Mode",
        theme_dark: "Dark Mode",
        sort: "Sort Order",
        sort_done: "Done Sorting",
        not_listening: "Not listening",
        unsaved_changes: "Unsaved Changes",
        log_details: "Query Details",
        resolution_chain: "Resolution Chain",
        block_domain: "Block Domain",
        unblock_domain: "Unblock Domain",
        blocked_msg: "Added to Hosts blacklist. Please click 'Save & Apply' at the top to take effect.",
        unblocked_msg: "Removed from Hosts blacklist. Please click 'Save & Apply' at the top to take effect.",
        no_records: "No records found",
        prev: "Previous",
        next: "Next"
    }
};

const FormInput = {
    props: ['label', 'modelValue', 'placeholder', 'type', 'disabled', 'inputClass'],
    emits: ['update:modelValue'],
    template: `
    <div class="w-full">
        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">{{ label }}</label>
        <input :type="type || 'text'" 
            :value="modelValue" 
            :disabled="disabled"
            @input="$emit('update:modelValue', $event.target.value)"
            class="shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-slate-300 dark:border-slate-700 rounded-lg px-3 border transition-all bg-white dark:bg-slate-950 dark:text-white disabled:bg-slate-100 disabled:text-slate-500"
            :class="inputClass"
            :style="{height: inputClass && inputClass.includes('h-') ? '' : '2.5rem'}"
            :placeholder="placeholder">
    </div>
    `
};

const ToggleSwitch = {
    props: ['label', 'modelValue', 'disabled'],
    emits: ['update:modelValue'],
    template: `
    <div class="flex items-center justify-between" :class="{'opacity-60': disabled}">
        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 mr-3">{{ label }}</span>
        <label class="flex items-center relative" :class="disabled ? 'cursor-not-allowed' : 'cursor-pointer'">
            <input type="checkbox" :checked="modelValue" :disabled="disabled" @change="$emit('update:modelValue', $event.target.checked)" class="toggle-input sr-only"/>
            <div class="toggle-track">
                <div class="toggle-checkbox"></div>
            </div>
        </label>
    </div>
    `
};

const Modal = {
    props: ['show', 'title', 'maxWidth'],
    emits: ['close'],
    template: `
    <div v-if="show" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-slate-900 bg-opacity-75 backdrop-blur-sm transition-opacity" aria-hidden="true" @click="$emit('close')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle w-full border border-slate-200 dark:border-slate-800" :class="maxWidth || 'sm:max-w-lg'">
                <div class="bg-white dark:bg-slate-900 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white" id="modal-title">{{ title }}</h3>
                            <div class="mt-4">
                                <slot></slot>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-950/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <slot name="footer"></slot>
                </div>
            </div>
        </div>
    </div>
    `
};

const app = Vue.createApp({
    components: {
        'form-input': FormInput,
        'toggle-switch': ToggleSwitch,
        'modal': Modal
    },
    data() {
        return {
            lang: 'zh',
            currentView: 'dashboard',
            isDark: false,
            sidebarOpen: false,
            desktopSidebarOpen: true,
            upstreamTab: 'cn',
            isSorting: false,
            draggedIndex: null,
            hostsArray: [],
            rulesArray: [],
            config: {
                listen: {},
                bootstrap_dns: [],
                tls_certificates: [],
                upstreams: { cn: [], overseas: [] },
                geo_data: {},
                auto_cert: { domains: [] },
                web_ui: {},
                query_log: { enabled: false, max_history: 5000, save_to_file: false, file: "" }
            },
            stats: {
                upstream_stats: [],
                top_clients: {},
                top_domains: {}
            },
            logs: [],
            logsPage: 1,
            logsTotal: 0,
            logsFilter: "",
            sortKey: "",
            sortOrder: 1,
            loading: false,
            statsTimer: null,
            logsTimer: null,
            
            loadingState: true,
            unsavedChanges: false,
            authEnabled: true,
            isLoggedIn: false,
            guestMode: false,
            loginForm: { username: '', password: '' },
            modal: {
                show: false,
                type: '', 
                title: '',
                maxWidth: '',
                testResults: [],
                log: {}
            }
        }
    },
    computed: {
        canView() {
            return !this.authEnabled || this.isLoggedIn || this.guestMode;
        },
        currentUpstreams() {
            return this.upstreamTab === 'cn' ? this.config.upstreams.cn : this.config.upstreams.overseas;
        },
        canEdit() {
            return !this.authEnabled || this.isLoggedIn;
        },
        sortedTopClients() {
            if (!this.stats.top_clients) return [];
            return Object.entries(this.stats.top_clients).sort((a, b) => b[1] - a[1]);
        },
        sortedTopDomains() {
            if (!this.stats.top_domains) return [];
            return Object.entries(this.stats.top_domains).sort((a, b) => b[1] - a[1]);
        },
        sortedLogs() {
            if (!this.sortKey) return this.logs;
            return [...this.logs].sort((a, b) => {
                let valA = a[this.sortKey];
                let valB = b[this.sortKey];
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return -1 * this.sortOrder;
                if (valA > valB) return 1 * this.sortOrder;
                return 0;
            });
        }
    },
    watch: {
        currentView(newVal) {
            localStorage.setItem('doh_current_view', newVal);
        },
        isDark(newVal) {
            localStorage.setItem('doh_theme', newVal ? 'dark' : 'light');
            if(newVal) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }
    },
    methods: {
        t(key) { return i18nData[this.lang][key] || key; },
        toggleLang() { this.lang = this.lang === 'zh' ? 'en' : 'zh'; },
        toggleTheme() { this.isDark = !this.isDark; },
        formatTime(ts) { 
             const d = new Date(ts);
             return d.toLocaleTimeString('zh-CN', { hour12: false }) + "." + d.getMilliseconds().toString().padStart(3, '0');
        },
        formatNumber(num) { return num ? num.toLocaleString() : 0; },
        formatUptime(sec) {
            if (!sec) return "0s";
            const d = Math.floor(sec / 86400);
            const h = Math.floor((sec % 86400) / 3600);
            const m = Math.floor((sec % 3600) / 60);
            let s = "";
            if (d > 0) s += d + "d ";
            if (h > 0) s += h + "h ";
            s += m + "m";
            return s;
        },
        formatListenPort(portValue) {
            return portValue && portValue.startsWith(':') ? portValue.substring(1) : portValue;
        },
        getStartTime(uptime) {
            if (!uptime) return '-';
            const now = new Date();
            const start = new Date(now.getTime() - uptime * 1000);
            return start.toLocaleString(this.lang === 'zh' ? 'zh-CN' : 'en-US', { hour12: false });
        },
        getPercentage(part, total) {
            if (!total) return 0;
            return ((part / total) * 100).toFixed(1);
        },
        getUpstreamClass(u) {
            if(!u) return "bg-gray-100 text-gray-800";
            if(u.includes("CN") || u.includes("Domestic")) return "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300";
            if(u.includes("Overseas")) return "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300";
            if(u.includes("Hosts")) return "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300";
            if(u.includes("Fail")) return "bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300";
            return "bg-gray-100 text-gray-800 dark:bg-slate-700 dark:text-slate-300";
        },
        getLatencyClass(ms) {
            if(!ms && ms !== 0) return "";
            if(ms < 50) return "text-green-600 dark:text-green-400";
            if(ms < 200) return "text-yellow-600 dark:text-yellow-400";
            return "text-red-600 dark:text-red-400";
        },
        getTestStatusClass(status) {
            return status === 'OK' ? 'text-green-600 dark:text-green-400 font-bold' : 'text-red-600 dark:text-red-400 font-bold';
        },
        sortBy(key) {
            if (this.sortKey === key) {
                this.sortOrder = -this.sortOrder;
            } else {
                this.sortKey = key;
                this.sortOrder = 1;
            }
        },
        getSortIcon(key) {
            if (this.sortKey !== key) return "fa-sort text-slate-300 dark:text-slate-600";
            return this.sortOrder === 1 ? "fa-sort-up active" : "fa-sort-down active";
        },
        showPipeline(p) { return p === 'tcp' || p === 'dot'; },
        showH3(p) { return p === 'doh'; },
        showVerify(p) { return p === 'dot' || p === 'doh' || p === 'doq'; },
        async checkAuth() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                this.authEnabled = data.enabled;
                this.isLoggedIn = data.authenticated;
                this.guestMode = data.guest_mode;
            } catch(e) { 
                console.error(e); 
            } finally {
                this.loadingState = false;
            }
        },
        openLogin() {
            this.loginForm = { username: '', password: '' };
            this.modal = { show: true, type: 'login', title: this.t('login_title'), maxWidth: 'sm:max-w-sm' };
        },
        async doLogin() {
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.loginForm)
                });
                if(res.ok) {
                    window.location.reload();
                } else {
                    alert(this.t('login_fail'));
                }
            } catch(e) { console.error(e); }
        },
        async doLogout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                this.isLoggedIn = false;
                window.location.reload();
            } catch(e) { console.error(e); }
        },
        async loadConfig() {
            try {
                const res = await fetch('/api/config');
                if(!res.ok) throw new Error("Failed to load");
                this.config = await res.json();
                if(!this.config.bootstrap_dns) this.config.bootstrap_dns = [];
                if(!this.config.tls_certificates) this.config.tls_certificates = [];
                if(!this.config.upstreams.cn) this.config.upstreams.cn = [];
                if(!this.config.upstreams.overseas) this.config.upstreams.overseas = [];
                if(!this.config.auto_cert) this.config.auto_cert = { domains: [] };
                if(!this.config.web_ui) this.config.web_ui = { guest_mode: false };
                if(this.config.web_ui && this.config.web_ui.guest_mode === undefined) this.config.web_ui.guest_mode = false;
                if(!this.config.query_log) this.config.query_log = { enabled: true, max_history: 5000, save_to_file: false, file: "" };
                if(!this.config.hosts) this.config.hosts = {};
                if(!this.config.rules) this.config.rules = {};
                if(!this.config.geo_data) this.config.geo_data = {};

                this.hostsArray = Object.entries(this.config.hosts).map(([d, i]) => ({domain: d, ip: i}));
                this.rulesArray = Object.entries(this.config.rules).map(([d, t]) => ({domain: d, target: t}));
                
                let idCounter = 0;
                const addId = (s) => { if(!s._id) s._id = Date.now() + (idCounter++); return s; };
                this.config.upstreams.cn.forEach(addId);
                this.config.upstreams.overseas.forEach(addId);

                const strip = (p) => p ? p.toString().replace(':', '') : '';
                if(this.config.listen) {
                    this.config.listen.dns_udp = strip(this.config.listen.dns_udp);
                    this.config.listen.dns_tcp = strip(this.config.listen.dns_tcp);
                    this.config.listen.doh = strip(this.config.listen.doh);
                    this.config.listen.dot = strip(this.config.listen.dot);
                    this.config.listen.doq = strip(this.config.listen.doq);
                }
            } catch(e) {
                console.error(e);
            }
        },
        async saveConfig() {
            if (!this.canEdit) return;
            this.loading = true;
            this.modal = { show: true, type: 'saving', title: this.t('saving_title'), maxWidth: 'sm:max-w-sm' };
            try {
                const cleanConfig = JSON.parse(JSON.stringify(this.config));
                if(cleanConfig.upstreams.cn) cleanConfig.upstreams.cn.forEach(s => delete s._id);
                if(cleanConfig.upstreams.overseas) cleanConfig.upstreams.overseas.forEach(s => delete s._id);

                cleanConfig.hosts = this.hostsArray.reduce((acc, cur) => { if(cur.domain) acc[cur.domain] = cur.ip; return acc; }, {});
                cleanConfig.rules = this.rulesArray.reduce((acc, cur) => { if(cur.domain) acc[cur.domain] = cur.target; return acc; }, {});

                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanConfig)
                });
                if(!res.ok) {
                    if(res.status === 401) {
                        this.modal.show = false;
                        this.openLogin();
                        return;
                    }
                    throw new Error(await res.text());
                }
                this.modal = { show: true, type: 'saved', title: this.t('saved_title'), maxWidth: 'sm:max-w-sm' };
            } catch(e) {
                this.modal.show = false;
                alert("Error: " + e.message);
            } finally {
                this.loading = false;
            }
        },
        reloadPage() {
            window.location.reload();
        },
        async testUpstreams() {
            if (!this.canEdit) return;
            this.modal = { show: true, type: 'testing', title: this.t('testing'), maxWidth: 'sm:max-w-sm' };
            try {
                const res = await fetch('/api/test-upstreams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config) 
                });
                if(!res.ok) {
                     if(res.status === 401) {
                        this.modal.show = false;
                        this.openLogin();
                        return;
                    }
                    throw new Error(await res.text());
                }
                const results = await res.json();
                this.modal = { show: true, type: 'test', title: this.t('test_results'), testResults: results, maxWidth: 'sm:max-w-5xl' };
            } catch(e) {
                this.modal.show = false;
                alert("Test Error: " + e.message);
            }
        },
        async fetchLogs(page = 1) {
            try {
                this.logsPage = page;
                let url = `/api/logs?page=${page}&limit=15`;
                if(this.logsFilter) url += '&q=' + encodeURIComponent(this.logsFilter);
                
                const res = await fetch(url);
                const data = await res.json();
                this.logs = data.data || [];
                this.logsTotal = data.total || 0;
            } catch(e) { console.error(e); }
        },
        async fetchStats() {
            try {
                const res = await fetch('/api/stats');
                this.stats = await res.json();
            } catch(e) { console.error(e); }
        },
        addBootstrap() { this.config.bootstrap_dns.push(""); },
        removeBootstrap(idx) { this.config.bootstrap_dns.splice(idx, 1); },
        addTLSCert() { this.config.tls_certificates.push({ cert_file: "", key_file: "" }); },
        removeTLSCert(idx) { this.config.tls_certificates.splice(idx, 1); },
        addUpstream(type) {
            const empty = { address: "", protocol: "udp", ecs_ip: "", pipeline: false, http3: false, insecure_skip_verify: false, _id: Date.now() };
            if(type === 'cn') this.config.upstreams.cn.push(empty);
            else this.config.upstreams.overseas.push(empty);
        },
        removeUpstream(type, idx) {
            if(confirm("Are you sure you want to delete this upstream?")) {
                if(type === 'cn') this.config.upstreams.cn.splice(idx, 1);
                else this.config.upstreams.overseas.splice(idx, 1);
            }
        },
        toggleSort() {
            this.isSorting = !this.isSorting;
        },
        onDragStart(index, event) {
            this.draggedIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.dropEffect = 'move';
        },
        onDragEnter(index) {
            if (this.draggedIndex === null || this.draggedIndex === index) return;

            const list = this.currentUpstreams;
            const draggedItem = list[this.draggedIndex];

            list.splice(this.draggedIndex, 1);
            list.splice(index, 0, draggedItem);

            this.draggedIndex = index;
        },
        onDragEnd() {
            this.draggedIndex = null;
        },
        showLogDetails(log) {
            this.modal = {
                show: true,
                type: 'log_details',
                title: this.t('log_details'),
                maxWidth: 'sm:max-w-2xl',
                log: log
            };
        },
        isBlocked(domain) {
            if (!domain) return false;
            const cleanDomain = domain.toLowerCase().replace(/\.$/, "");
            return this.hostsArray.some(h => h.domain.toLowerCase() === cleanDomain && h.ip === '0.0.0.0');
        },
        blockDomain(domain) {
            if (!this.canEdit) return;
            const cleanDomain = domain.toLowerCase().replace(/\.$/, "");
            if (this.isBlocked(cleanDomain)) return;
            
            this.hostsArray.push({ domain: cleanDomain, ip: '0.0.0.0' });
            this.unsavedChanges = true;
            this.config.hosts[cleanDomain] = '0.0.0.0';
            
            alert(this.t('blocked_msg'));
            this.modal.show = false;
        },
        unblockDomain(domain) {
             if (!this.canEdit) return;
             const cleanDomain = domain.toLowerCase().replace(/\.$/, "");
             const idx = this.hostsArray.findIndex(h => h.domain.toLowerCase() === cleanDomain && h.ip === '0.0.0.0');
             if (idx !== -1) {
                 this.hostsArray.splice(idx, 1);
                 delete this.config.hosts[cleanDomain];
                 this.unsavedChanges = true;
                 alert(this.t('unblocked_msg'));
                 this.modal.show = false;
             }
        }
    },
    mounted() {
        const savedView = localStorage.getItem('doh_current_view');
        if(savedView) this.currentView = savedView;
        
        const savedTheme = localStorage.getItem('doh_theme');
        if(savedTheme === 'dark') {
            this.isDark = true;
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && !savedTheme) {
             this.isDark = true;
        }

        this.checkAuth();
        this.loadConfig();
        this.fetchStats();
        this.statsTimer = setInterval(this.fetchStats, 3000);
        this.logsTimer = setInterval(() => {
            if(this.currentView === 'logs') this.fetchLogs(this.logsPage);
        }, 3000);
    },
    unmounted() {
        clearInterval(this.statsTimer);
        clearInterval(this.logsTimer);
    }
});

app.mount('#app');
</script>
</body>
</html>